function rgba2Color(e,i,t,a){return e<<24|i<<16|t<<8|a}function NinePatch(e,i){this.div=e,this.padding={top:0,left:0,right:0,bottom:0};var t=this;this.bgImage=new Image,this.bgImage.onload=function(){t.originalBgColor=t.div.css("background-color"),"none"===t.originalBgColor&&(t.originalBgColor=""),t.div.css("background","none");var e,i;i=document.createElement("canvas"),i.width=t.bgImage.width,i.height=t.bgImage.height,e=i.getContext("2d"),e.drawImage(t.bgImage,0,0);var a=e.getImageData(0,0,t.bgImage.width,1).data,s=rgba2Color(a[0],a[1],a[2],a[3]),r=rgba2Color(a[a.length-4],a[a.length-3],a[a.length-2],a[a.length-1]);t.horizontalPieces=t.getPieces(a.slice(4,a.length-4),s,r),a=e.getImageData(0,1,1,t.bgImage.height-2).data,t.verticalPieces=t.getPieces(a,s,r);var h=e.getImageData(t.bgImage.width-1,0,1,t.bgImage.height).data,o=t.getBorderPadding(h,t.verticalPieces);t.padding.top=o.begin,t.padding.bottom=o.end,h=e.getImageData(0,t.bgImage.height-1,t.bgImage.width,1).data;var n=t.getBorderPadding(h,t.horizontalPieces);t.padding.left=n.begin,t.padding.right=n.end,3===t.horizontalPieces.length&&3===t.verticalPieces.length&&"s"===t.horizontalPieces[0][0]&&"s"!==t.horizontalPieces[1][0]&&"s"===t.horizontalPieces[2][0]&&"s"===t.verticalPieces[0][0]&&"s"!==t.verticalPieces[1][0]&&"s"===t.verticalPieces[2][0]?t.drawCSS3():(t.draw(),t.div.on("resize",t.draw))},this.bgImage.src=i}NinePatch.prototype.div=null,NinePatch.prototype.padding=null,NinePatch.prototype.originalBgColor=null,NinePatch.prototype.horizontalPieces=null,NinePatch.prototype.verticalPieces=null,NinePatch.prototype.bgImage=null,NinePatch.prototype.getPieces=function(e,i,t){var a,s,r,h,o,n,g,c=[];for(o=rgba2Color(e[0],e[1],e[2],e[3]),a=o===i?"s":o===t?"r":"d",r=1,n=4;n<e.length;n+=4)g=n/4+1,o=rgba2Color(e[n],e[n+1],e[n+2],e[n+3]),s=o===i?"s":o===t?"r":"d",a!==s&&(h=g-r,c.push([a,r,h]),a=s,r=g);return h=g-r+1,c.push([a,r,h]),c},NinePatch.prototype.getBorderPadding=function(e,i){var t,a,s=rgba2Color(e[0],e[1],e[2],e[3]),r={begin:0,end:0},h=!1;for(t=4;t<e.length;t+=4)if(a=rgba2Color(e[t],e[t+1],e[t+2],e[t+3]),a!==s){h=!0;break}if(!h)return r.begin=i[0][2],r.end=i[i.length-1][2],r;for(r.begin=t/4-1,t=e.length-8;t>=0&&(a=rgba2Color(e[t],e[t+1],e[t+2],e[t+3]),a===s);t-=4);return r.end=(e.length-t)/4-1,r},NinePatch.prototype.draw=function(){if(null!==this.horizontalPieces){var e=document.createElement("canvas");e.width=this.div.width()+this.padding.left+this.padding.right,e.height=this.div.height()+this.padding.top+this.padding.bottom;var i,t,a,s=e.getContext("2d"),r=0,h=0;for(a=0;a<this.horizontalPieces.length;a++)"s"===this.horizontalPieces[a][0]?r+=this.horizontalPieces[a][2]:h++;i=(e.width-r)/h;var o=0;for(h=0,a=0;a<this.verticalPieces.length;a++)"s"===this.verticalPieces[a][0]?o+=this.verticalPieces[a][2]:h++;t=(e.height-o)/h;var n,g;for(a=0;a<this.verticalPieces.length;a++){for(var c=0;c<this.horizontalPieces.length;c++){if(n="d"===this.horizontalPieces[c][0]?i:this.horizontalPieces[c][2],g="d"===this.verticalPieces[a][0]?t:this.verticalPieces[a][2],"r"!==this.verticalPieces[a][0])s.drawImage(this.bgImage,this.horizontalPieces[c][1],this.verticalPieces[a][1],this.horizontalPieces[c][2],this.verticalPieces[a][2],0,0,n,g);else{var l=document.createElement("canvas");l.width=this.horizontalPieces[c][2],l.height=this.verticalPieces[a][2];var d=l.getContext("2d");d.drawImage(this.bgImage,this.horizontalPieces[c][1],this.verticalPieces[a][1],this.horizontalPieces[c][2],this.verticalPieces[a][2],0,0,this.horizontalPieces[c][2],this.verticalPieces[a][2]),s.fillStyle=s.createPattern(l,"repeat"),s.fillRect(0,0,n,g)}s.translate(n,0)}s.translate(-e.width,"s"===this.verticalPieces[a][0]?this.verticalPieces[a][2]:t)}var P=e.toDataURL("image/png");this.div.css("background",this.originalBgColor+" url("+P+") no-repeat"),this.div.css("padding-left",this.padding.left),this.div.css("padding-right",this.padding.right),this.div.css("padding-top",this.padding.top),this.div.css("padding-bottom",this.padding.bottom)}},NinePatch.prototype.drawCSS3=function(){var e,i;i=document.createElement("canvas"),e=i.getContext("2d"),i.width=this.bgImage.width-2,i.height=this.bgImage.height-2,e.drawImage(this.bgImage,-1,-1);var t=i.toDataURL("image/png"),a=this.verticalPieces[0][2]+"px "+this.horizontalPieces[2][2]+"px "+this.verticalPieces[2][2]+"px "+this.horizontalPieces[0][2]+"px",s=this.verticalPieces[0][2]+" "+this.horizontalPieces[2][2]+" "+this.verticalPieces[2][2]+" "+this.horizontalPieces[0][2];this.div.css("border-width",a),this.div.css("border-style","solid"),this.div.css("padding","0"),this.div.css("border-image","url("+t+") "+s+" fill "+("r"===this.horizontalPieces[1][1]?"repeat":"stretch")+" "+("r"===this.verticalPieces[1][1]?"repeat":"stretch"))},window.NinePatch=NinePatch,$(function(){$("div").each(function(){var e=$(this),i=e.css("background-image").match(/\(\s*['"](.*?\.9\.(?:png|gif))['"]\s*\)/i);i&&new NinePatch(e,i[1])})});